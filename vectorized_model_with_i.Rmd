---
title: "Vectorized model"
author: "Maggie Walters"
date: "September 27, 2017"
output: pdf_document
---
```{r setup}
rm(list = ls())
install.packages('deSolve', dependencies = TRUE, repos='http://cran.us.r-project.org')
library(deSolve)

```

```{r initial conditions}
percentage_vec <- c(rep(1.92,5), rep(1.84,5), rep(1.8,5), rep(1.74,5),
                    17.5, 15, 12.1, 8.9, 5.7, 3, 1.4, 0.2)
percentage_vec <- percentage_vec / 100
initial_conditions <- as.data.frame(matrix(NA, nrow = 28*4, ncol = 3))
initial_conditions[,2] <- rep(1:28,4)
for(i in 1:4){
  x <- i - 1
  initial_conditions[x*(28) + (1:28),1] <- rep(i,28)
}
initial_conditions[,3] <- rep(percentage_vec,4)

susceptible_init <- cbind(initial_conditions[,1], initial_conditions[,2], rep(NA, 112))
susceptible_init[,3] <- c(initial_conditions[1:28,3] * 3 *10^6, initial_conditions[29:56,3] * 1.5 * 10^6, 
                          initial_conditions[57:84,3] * 0.25 * 10^6, initial_conditions[85:112,3] * 0.24 * 10^6)

infected_init <- cbind(initial_conditions[,1], initial_conditions[,2], rep(NA, 112))
infected_init[,3] <- c(initial_conditions[1:28,3] * 1, initial_conditions[29:56,3] * 0, 
                         initial_conditions[57:84,3] * 0, initial_conditions[85:112,3] * 0)

recovered_init <- cbind(initial_conditions[,1], initial_conditions[,2], rep(NA, 112))
recovered_init[,3] <- c(initial_conditions[1:28,3] * 0, initial_conditions[29:56,3] * 0, 
                         initial_conditions[57:84,3] * 0, initial_conditions[85:112,3] * 0)


susceptible <- function(exposure){
    x <- exposure - 1
    susceptible <- c(x * 84 + susceptible_init[1:28,3])
  }
susceptible_total <- susceptible(1) + susceptible(2) + susceptible(3) + susceptible(4)
  
infected <- function(exposure){
    x <- exposure - 1
    infected <- c(x * 84 + infected_init[1:28,3])
  } 
infected_total <- infected(1) + infected(2) + infected(3) + infected(4)
  
recovered <- function(exposure){
    x <- exposure - 1
    recovered <- c(x * 84 + recovered_init[1:28,3])
  } 
recovered_total <- recovered(1) + recovered(2) + recovered(3) + recovered(4)
  
population <- sum(susceptible_total + infected_total + recovered_total)

parms <- c(beta = 0.05,
          gamma = 0.25,
          sigma = 1/(365* 1.4),
          mu = 19 / (1000 * 365),
          delta = 8 / (1000 * 365),
          age_window = c(rep(1, 21), rep(10, 7)))


```

Notes on parameters:
Halsted and Zompi (2015) say that cross-protection could last any where from 1.4 to 1.9 years. Also notes that cross-protection could be longer for more severe cases. Could this be altered for the second infection then? Should it be amplified for R2 to S3?

Mu (birth) was altered to reflect 19 births per 1000 people per year, but put on a daily scale. 

Delta (death) was altered to reflect 8 deaths per 1000 people per year, but put on a daily scale. 

```{r Model}
model <- function(t, y, parms){

beta <- parms[1]
gamma <- parms[2]
sigma <- parms[3]
mu <- parms[4]
delta <- parms[5]
age_window <- parms[6:33]

S1 <- y[1:28]
I1 <- y[29:56]
R1 <- y[57:84]
S2 <- y[85:112]
I2 <- y[113:140]
R2 <- y[141:168]
S3 <- y[169:196]
I3 <- y[197:224]
R3 <- y[225:252]
S4 <- y[253:280]
I4 <- y[281:308]
R4 <- y[309:336]

infected_total <- sum(sum(I1), sum(I2), sum(I3), sum(I4))
population <- sum(y)

    #first infection
    dS1 <-  
      #DEMO OUT: due to infection and death. E.g. move from s_1_1 to i_1_1
      S1 * (-beta * sum(infected_total) - delta) 
      #DEMO OUT: due to aging. E.g. move from s_1_1 to s_1_2
      - (1/365) * (1/age_window) * c(head(S1, - 1), 0)
      #DEMO IN: due to births and aging
      + mu * c(population, rep(0,27)) + c(0, (1/365) * (1/(head(age_window, -1)))) * c(head(S1, -1), 0)
    dI1 <- 
      #DEMO IN: due to infection 
      S1 * (beta * sum(infected_total))
      #DEMO IN: due to aging
      + c(0, gamma * (1/365)) * c(head(I1, -1), 0)
      #DEMO OUT: due to aging
      - gamma * (1/365) * c(head(I1, -1), 0)
      #DEMO OUT: due to recovery and death
      - I1 * (gamma + delta)
    dR1 <-
      #DEMO IN: due to recovery
      I1 * gamma 
      #DEMO IN: due to aging
      + c(0, sigma * (1/365)) * c(head(R1, -1), 0)
      #DEMO OUT: due to aging
      - sigma * (1/365) *c(head(R1, -1), 0)
      #DEMO OUT: due to death and loss of cross-protection
      - R1 * (delta + sigma)
    
    #second infection
    dS2 <- 
      #DEMO OUT: due to infection and death
      S2 * ((-3/4) * beta * sum(infected_total) - delta) 
      #DEMO OUT: due to aging.
      - (1/365) * (1/age_window)*c(head(S2, - 1), 0)
      #DEMO IN: due to aging 
      + c(0, (1/365)*(1/(head(age_window, -1)))) * c(head(S2, -1),0)
      #DEMO IN: loss of cross-protection
      + sigma * R1 
    dI2 <- 
      #DEMO IN: due to infection
      S2 * ((3/4) * beta * sum(infected_total)) 
      #DEMO IN: due to aging
      + c(0, gamma * (1/365)) * c(head(I2, -1), 0)
      #DEMO OUT: due to aging
      - gamma * (1/365) * c(head(I2, -1), 0)
      #DEMO OUT: due to recovery and death
      - I2 * (gamma + delta)
    dR2 <-  
      #DEMO IN: due to recovery
      I2 * gamma 
      #DEMO IN: due to aging
      + c(0, sigma * (1/365)) * c(head(R2, -1), 0)
      #DEMO OUT: due to aging
      - sigma * (1/365) *c(head(R2, -1), 0)
      #DEMO OUT: due to death and loss of cross-protection
      - R2 * (delta + sigma)
    
    #third infection
    dS3 <- 
      #DEMO OUT: due to infection and death
      S3 * ((-2/4) * beta * sum(infected_total) - delta) 
      #DEMO OUT: due to aging.
      - (1/365) * (1/age_window)*c(head(S3, - 1), 0) 
      #DEMO IN: due to aging 
      + c(0, (1/365)*(1/(head(age_window, -1)))) * c(head(S3, -1),0)
      #DEMO IN: loss of cross-protection
      + sigma * R2
    dI3 <- 
      #DEMO IN: due to infection
      S3 * ((2/4) * beta * sum(infected_total)) 
      #DEMO IN: due to aging
      + c(0, gamma * (1/365)) * c(head(I3, -1), 0)
      #DEMO OUT: due to aging
      - gamma * (1/365) * c(head(I3, -1), 0)
      #DEMO OUT: due to recovery and death
      - I3 * (gamma + delta)
    dR3 <- 
      #DEMO IN: due to recovery
      I3 * gamma 
      #DEMO IN: due to aging
      + c(0, sigma * (1/365)) * c(head(R3, -1), 0)
      #DEMO OUT: due to aging
      - sigma * (1/365) *c(head(R3, -1), 0)
      #DEMO OUT: due to death and loss of cross-protection
      - R3 * (delta + sigma) 
    
    #fourth infection
    dS4 <- 
      #DEMO OUT: due to infection and death
      S4 * ((-1/4) * beta * sum(infected_total) - delta) 
      #DEMO OUT: due to aging.
      - (1/365) * (1/age_window)*c(head(S4, - 1), 0)
      #DEMO IN: due to aging 
      + c(0, (1/365)*(1/(head(age_window, -1)))) * c(head(S4, -1),0)
      #DEMO IN: loss of cross-protection
      + sigma * R3
    dI4 <- 
      #DEMO IN: due to infection
      S4 * ((1/4) * beta * sum(infected_total)) 
      #DEMO IN: due to aging
      + c(0, gamma * (1/365)) * c(head(I4, -1), 0)
      #DEMO OUT: due to aging
      - gamma * (1/365) * c(head(I4, -1), 0)
      #DEMO OUT: due to recovery and death
      - I4 * (gamma + delta)
    dR4 <- 
      #DEMO IN: due to recovery
      I4 * gamma 
      #DEMO IN: due to aging
      + c(0, sigma * (1/365)) * c(head(R4, -1), 0)
      #DEMO OUT: due to aging
      - sigma * (1/365) *c(head(R4, -1), 0)
      #DEMO OUT: due to death and loss of cross-protection
      - R4 * (delta) 
    
  list(c(dS1, dI1, dR1,
         dS2, dI2, dR2,
         dS3, dI3, dR3,
         dS4, dI4, dR4))
  }
```
susceptible(1) refers to the initial conditions but it should instead be in terms of y. e.g. for susceptible 1 age group 1 would be y[1]

* do for infected_total as well, or anything that has to do with the values of the compartments.
put age_window in parms


```{r}
y_init <- c(susceptible(1), infected(1), recovered(1),
            susceptible(2), infected(2), recovered(2),
            susceptible(3), infected(3), recovered(3),
            susceptible(4), infected(4), recovered(4))

times <- seq(from = 0, to = 365 * 10, by = .1)

out <- ode(times = times, y = y_init, func = model, parms = parms)

plot(out)
```

##NOTES ON OUTPUT:

* Reach 0 susceptibles 1's by the 64th timestep. 
* Something after the first timestep is immediately moving all susceptible(1) into the infected(1) category. 





