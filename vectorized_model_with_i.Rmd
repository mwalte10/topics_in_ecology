---
title: "Vectorized model"
author: "Maggie Walters"
date: "September 27, 2017"
output: pdf_document
---
```{r setup}
rm(list = ls())
install.packages('deSolve', dependencies = TRUE, repos='http://cran.us.r-project.org')
library(deSolve)

```

```{r initial conditions}
percentage_vec <- c(rep(1.92,5), rep(1.84,5), rep(1.8,5), rep(1.74,5),
                    17.5, 15, 12.1, 8.9, 5.7, 3, 1.4, 0.2)
percentage_vec <- percentage_vec / 100
initial_conditions <- as.data.frame(matrix(NA, nrow = 28*4, ncol = 3))
initial_conditions[,2] <- rep(1:28,4)
for(i in 1:4){
  x <- i - 1
  initial_conditions[x*(28) + (1:28),1] <- rep(i,28)
}
initial_conditions[,3] <- rep(percentage_vec,4)

susceptible_init <- cbind(initial_conditions[,1], initial_conditions[,2], rep(NA, 112))
susceptible_init[,3] <- c(initial_conditions[1:28,3] * 1 *10^6, initial_conditions[29:56,3] * 0.5 * 10^6, 
                          initial_conditions[57:84,3] * 0.25 * 10^6, initial_conditions[85:112,3] * 0.25 * 10^6)

infected_init <- cbind(initial_conditions[,1], initial_conditions[,2], rep(NA, 112))
infected_init[,3] <- c(initial_conditions[1:28,3] * 1, initial_conditions[29:56,3] * 0, 
                         initial_conditions[57:84,3] * 0, initial_conditions[85:112,3] * 0)

recovered_init <- cbind(initial_conditions[,1], initial_conditions[,2], rep(NA, 112))
recovered_init[,3] <- c(initial_conditions[1:28,3] * 0, initial_conditions[29:56,3] * 0, 
                         initial_conditions[57:84,3] * 0, initial_conditions[85:112,3] * 0)


susceptible <- function(exposure){
    x <- exposure - 1
    susceptible <- c(susceptible_init[(x * 28) + 1:28,3])
  }
susceptible_total <- sum(susceptible(1) + susceptible(2) + susceptible(3) + susceptible(4))
  
infected <- function(exposure){
    x <- exposure - 1
    infected <- c(infected_init[(x * 28) + 1:28,3])
  } 
infected_total <- sum(infected(1) + infected(2) + infected(3) + infected(4))
  
recovered <- function(exposure){
    x <- exposure - 1
    recovered <- c(recovered_init[(x * 28) + 1:28,3])
  } 
recovered_total <- sum(recovered(1) + recovered(2) + recovered(3) + recovered(4))
  
population <- sum(susceptible_total + infected_total + recovered_total)

parms <- c(beta = 3e-10,
          gamma = 2.5e-10,
          sigma = 1/(365 * 1.4),
          mu = 19 / (1000 * 365),
          delta = 8 / (1000 * 365),
          age_window = c(rep(1, 21), rep(10, 7)))


```

Notes on parameters:
Halsted and Zompi (2015) say that cross-protection could last any where from 1.4 to 1.9 years. Also notes that cross-protection could be longer for more severe cases. Could this be altered for the second infection then? Should it be amplified for R2 to S3?

Mu (birth) was altered to reflect 19 births per 1000 people per year, but put on a daily scale. 

Delta (death) was altered to reflect 8 deaths per 1000 people per year, but put on a daily scale. 

Eventually the age distribution in the later infections should be higher for older individuals

```{r Model}
model <- function(t, y, parms){

beta <- parms[1]
gamma <- parms[2]
sigma <- parms[3]
mu <- parms[4]
delta <- parms[5]
age_window <- parms[6:33]

S1 <- y[1:28]
I1 <- y[29:56]
R1 <- y[57:84]
S2 <- y[85:112]
I2 <- y[113:140]
R2 <- y[141:168]
S3 <- y[169:196]
I3 <- y[197:224]
R3 <- y[225:252]
S4 <- y[253:280]
I4 <- y[281:308]
R4 <- y[309:336]

infected_total <- sum(sum(I1), sum(I2), sum(I3), sum(I4))
population <- sum(y)

    #first infection
    dS1 <-  
      -S1 * (beta * infected_total) - S1 * delta 
      - (1/365) * (1/c(head(age_window, -1), 0)) * c(head(S1, - 1), 0)
      + mu * c(population, rep(0,27)) 
      + c(0, (1/365) * (1/(head(age_window, -1)))) * c(0, head(S1, -1))
    
    dI1 <- 
      S1 * (beta * infected_total)
      + (1/365) * (1/c(head(age_window, -1), 0)) * c(head(I1, -1), 0)
      - (1/365) * (1/c(head(age_window, -1), 0)) * c(head(I1, - 1), 0)
      - I1 * (gamma + delta)
    
    dR1 <-
      I1 * gamma 
      + (1/365) * (1/c(head(age_window, -1), 0)) * c(head(R1, -1), 0)
      - (1/365) * (1/c(head(age_window, -1), 0)) * c(head(R1, - 1), 0)
      - R1 * (delta + sigma)
    
    #second infection
    dS2 <- 
      S2 * ((-3/4) * beta * infected_total - delta) 
      - (1/365) * (1/c(head(age_window, -1), 0)) *c(head(S2, - 1), 0)
      + (1/365)*(1/c(head(age_window, -1), 0)) * c(head(S2, -1),0)
      + sigma * R1 
    
    dI2 <- 
      S2 * ((3/4) * beta * infected_total)
      + (1/365) * (1/c(head(age_window, -1), 0)) * c(head(I2, -1), 0)
      - (1/365) * (1/c(head(age_window, -1), 0)) * c(head(I2, - 1), 0)
      - I2 * (gamma + delta)
    
    dR2 <-  
      I2 * gamma 
      + (1/365) * (1/c(head(age_window, -1), 0)) * c(head(R2, -1), 0)
      - (1/365) * (1/c(head(age_window, -1), 0)) * c(head(R2, - 1), 0)
      - R2 * (delta + sigma)
    
    #third infection
    dS3 <- 
      S3 * ((-2/4) * beta * infected_total - delta) 
      - (1/365) * (1/c(head(age_window, -1), 0))*c(head(S3, - 1), 0) 
      + (1/365)*(1/c(head(age_window, -1), 0)) * c(head(S3, -1),0)
      + sigma * R2
    
    dI3 <- 
      S3 * ((2/4) * beta * infected_total) 
      + (1/365) * (1/c(head(age_window, -1), 0)) * c(head(I3, -1), 0)
      - (1/365) * (1/c(head(age_window, -1), 0)) * c(head(I3, - 1), 0)
      - I3 * (gamma + delta)
    
    dR3 <- 
      I3 * gamma 
      + (1/365) * (1/c(head(age_window, -1), 0)) * c(head(R3, -1), 0)
      - (1/365) * (1/c(head(age_window, -1), 0)) * c(head(R3, - 1), 0)
      - R3 * (delta + sigma) 
    
    #fourth infection
    dS4 <- 
      S4 * ((-1/4) * beta * sum(infected_total) - delta) 
      - (1/365) * (1/c(head(age_window, -1), 0))*c(head(S4, - 1), 0)
      + (1/365)*(1/c(head(age_window, -1), 0)) * c(head(S4, -1),0)
      + sigma * R3
    
    dI4 <- 
      S4 * ((1/4) * beta * infected_total) 
      + (1/365) * (1/c(head(age_window, -1), 0)) * c(head(I4, -1), 0)
      - (1/365) * (1/c(head(age_window, -1), 0)) * c(head(I4, - 1), 0)
      - I4 * (gamma + delta)
    
    dR4 <- 
      I4 * gamma 
      + (1/365) * (1/c(head(age_window, -1), 0)) * c(head(R4, -1), 0)
      - (1/365) * (1/c(head(age_window, -1), 0)) * c(head(R4, - 1), 0)
      - R4 * (delta) 
    
  list(c(dS1, dI1, dR1,
         dS2, dI2, dR2,
         dS3, dI3, dR3,
         dS4, dI4, dR4))
  

  }
```


```{r}
y_init <- c(susceptible(1), infected(1), recovered(1),
            susceptible(2), infected(2), recovered(2),
            susceptible(3), infected(3), recovered(3),
            susceptible(4), infected(4), recovered(4))

times <- seq(from = 0, to = 365 * 5, by = .1)

out <- ode(times = times, y = y_init, func = model, parms = parms)


```


```{r}
matplot(sapply(1:28,function(aa)rowSums(out[,1+((1:12)-1)*28+aa])),type='l',lty=1)


sum_titles <- c("SUSCEPTIBLE(1)", "INFECTED(1)", "RECOVERED(1)",
           "SUSCEPTIBLE(2)", "INFECTED(2)", "RECOVERED(2)", 
          "SUSCEPTIBLE(3)", "INFECTED(3)","RECOVERED(3)", 
         "SUSCEPTIBLE(4)", "INFECTED(4)", "RECOVERED(4)")

for(i in 1:12){
  plot(out[,1],rowSums(out[,(1+(i-1)*28+1):(1+(i)*28)]),type='l',main = sum_titles[i])
}


```



