---
title: "Vectorized model"
author: "Maggie Walters"
date: "September 27, 2017"
output: pdf_document
---
```{r setup}
rm(list = ls())
install.packages('deSolve', dependencies = TRUE, repos='http://cran.us.r-project.org')
library(deSolve)

```

```{r initial conditions}
percentage_vec <- c(rep(1.8,5), rep(1.8,5), rep(1.84,5), rep(1.86,5),
                    17.2, 15, 12.7, 8.8, 5.5, 2.8, 1.3, 0.2)
percentage_vec <- percentage_vec / 100
initial_conditions <- as.data.frame(matrix(NA, nrow = 28*4, ncol = 3))
initial_conditions[,2] <- rep(1:28,4)
for(i in 1:4){
  x <- i - 1
  initial_conditions[x*(28) + (1:28),1] <- rep(i,28)
}
initial_conditions[,3] <- rep(percentage_vec,4)

susceptible_init_h <- cbind(initial_conditions[,1], initial_conditions[,2], rep(NA, 112))
susceptible_init_h[,3] <- c(initial_conditions[1:28,3] * 6 *10^6, initial_conditions[29:56,3] * 0, 
                          initial_conditions[57:84,3] * 0, initial_conditions[85:112,3] * 0)
susceptible_init_l <- cbind(initial_conditions[,1], initial_conditions[,2], rep(NA, 112))
susceptible_init_l[,3] <- c(initial_conditions[1:28,3] * 6 *10^6, initial_conditions[29:56,3] * 0, 
                          initial_conditions[57:84,3] * 0, initial_conditions[85:112,3] * 0)

infected_init_h <- cbind(initial_conditions[,1], initial_conditions[,2], rep(NA, 112))
infected_init_h[,3] <- c(initial_conditions[1:28,3] * 1, initial_conditions[29:56,3] * 0, 
                         initial_conditions[57:84,3] * 0, initial_conditions[85:112,3] * 0)
infected_init_l <- cbind(initial_conditions[,1], initial_conditions[,2], rep(NA, 112))
infected_init_l[,3] <- c(initial_conditions[1:28,3] * 1, initial_conditions[29:56,3] * 0, 
                         initial_conditions[57:84,3] * 0, initial_conditions[85:112,3] * 0)

recovered_init_h <- cbind(initial_conditions[,1], initial_conditions[,2], rep(NA, 112))
recovered_init_h[,3] <- c(initial_conditions[1:28,3] * 0, initial_conditions[29:56,3] * 0, 
                         initial_conditions[57:84,3] * 0, initial_conditions[85:112,3] * 0)
recovered_init_l <- cbind(initial_conditions[,1], initial_conditions[,2], rep(NA, 112))
recovered_init_l[,3] <- c(initial_conditions[1:28,3] * 0, initial_conditions[29:56,3] * 0, 
                         initial_conditions[57:84,3] * 0, initial_conditions[85:112,3] * 0)


susceptible_h <- function(exposure){
    x <- exposure - 1
    susceptible <- c(susceptible_init_h[(x * 28) + 1:28,3])
  }
susceptible_total_h <- sum(susceptible_h(1) + susceptible_h(2) + susceptible_h(3) + susceptible_h(4))
susceptible_l <- function(exposure){
    x <- exposure - 1
    susceptible <- c(susceptible_init_l[(x * 28) + 1:28,3])
  }
susceptible_total_l <- sum(susceptible_l(1) + susceptible_l(2) + susceptible_l(3) + susceptible_l(4))
  
infected_h <- function(exposure){
    x <- exposure - 1
    infected <- c(infected_init_h[(x * 28) + 1:28,3])
  } 
infected_total_h <- sum(infected_h(1) + infected_h(2) + infected_h(3) + infected_h(4))
infected_l <- function(exposure){
    x <- exposure - 1
    infected <- c(infected_init_l[(x * 28) + 1:28,3])
  } 
infected_total_l <- sum(infected_l(1) + infected_l(2) + infected_l(3) + infected_l(4))

recovered_h <- function(exposure){
    x <- exposure - 1
    recovered <- c(recovered_init_h[(x * 28) + 1:28,3])
  } 
recovered_total_h <- sum(recovered_h(1) + recovered_h(2) + recovered_h(3) + recovered_h(4))
recovered_l <- function(exposure){
    x <- exposure - 1
    recovered <- c(recovered_init_l[(x * 28) + 1:28,3])
  } 
recovered_total_l <- sum(recovered_l(1) + recovered_l(2) + recovered_l(3) + recovered_l(4))
  
population_h <- sum(susceptible_total_h + infected_total_h + recovered_total_h)
population_l <- sum(susceptible_total_l + infected_total_l + recovered_total_l)

parms <- c(beta = 0.75,
          beta_l = 1.25,
          gamma = 1/4,
          sigma = 1/(365 * 1.2),
          mu = 19 / (1000 * 365),
          delta = c((0.013 / 365), rep(0.001 / 365, 4), rep(0, 10), rep(0.001, 5), 
                    0.002 / 365, 0.0025 / 365, 
                    0.004 / 365, 0.0085 / 365,
                    0.0175 / 365, 0.0425 / 365,
                    0.114 / 365, 0.151 / 365),
          age_window = c(rep(1, 21), rep(10, 7)))
```

Notes on parameters:
Halsted and Zompi (2015) say that cross-protection could last any where from 1.4 to 1.9 years. Also notes that cross-protection could be longer for more severe cases. Could this be altered for the second infection then? Should it be amplified for R2 to S3?

Percentage_vec was updated to reflect Mexico's age pyramid using: https://www.populationpyramid.net/mexico/2016/

Mu (birth) was altered to reflect 19 births per 1000 people per year, but put on a daily scale. 

    * Also have the fertility rates for women aged 15-19 and 19-49 by country. 
      * 70.9 / 1000 women per year. So 70.9 / 2000 * 365. 
      * http://apps.who.int/gho/data/view.main.1630AG

Delta (death) was obtained from: http://apps.who.int/gho/data/view.main.61060

    * Used Mexico
Eventually the age distribution in the later infections should be higher for older individuals

Changed initial conditions to put Mexico's entire population in the susceptible category and ten people in the initial infection category. 

    * I am using the current population right now, but should this be changed to the population from one hundred years ago? If yes, then should delta be time sensitive? 

```{r Model}
model <- function(t, y, parms){

beta <- parms[1]
beta_l <- parms[2]
gamma <- parms[3]
sigma <- parms[4]
mu <- parms[5]
delta <- parms[6:33]
age_window <- parms[34:61]

S1_h <- y[1:28]
I1_h <- y[29:56]
R1_h <- y[57:84]
S2_h <- y[85:112]
I2_h <- y[113:140]
R2_h <- y[141:168]
S3_h <- y[169:196]
I3_h <- y[197:224]
R3_h <- y[225:252]
S4_h <- y[253:280]
I4_h <- y[281:308]
R4_h <- y[309:336]

S1_l <- y[337:364]
I1_l <- y[365:392]
R1_l <- y[393:420]
S2_l <- y[421:448]
I2_l <- y[449:476]
R2_l <- y[477:504]
S3_l <- y[505:532]
I3_l <- y[533:560]
R3_l <- y[561:588]
S4_l <- y[589:616]
I4_l <- y[617:644]
R4_l <- y[645:672]

infected_total_h <- sum(sum(I1_h), sum(I2_h), sum(I3_h), sum(I4_h))
population_h <- sum(y[1:336])
infected_total_l <- sum(sum(I1_l), sum(I2_l), sum(I3_l), sum(I4_l))
population_l <- sum(y[337:672])

    #first infection
    dS1 <-  
      mu * c(population_h, rep(0,27)) +
      c(0, 1/365 / head(age_window, -1) * head(S1_h, -1)) -
      c(1/365 / head(age_window, -1) * head(S1_h, -1), 0) -
      S1_h * (beta * infected_total_h / population_h) -
      S1_h * delta
    dS1_L <-  
      mu * c(population_l, rep(0,27)) +
      c(0, 1/365 / head(age_window, -1) * head(S1_l, -1)) -
      c(1/365 / head(age_window, -1) * head(S1_l, -1), 0) -
      S1_l * (beta_l * infected_total_l / population_l) -
      S1_l * delta

    dI1 <- 
      S1_h * (beta * infected_total_h / population_h) +
      c(0, 1/365 / head(age_window, -1) * head(I1_h, -1)) -
      c(1/365 / head(age_window, -1) * head(I1_h, -1), 0) -
      I1_h * gamma -
      I1_h * delta
    dI1_L <- 
      S1_l * (beta_l * infected_total_l / population_l) +
      c(0, 1/365 / head(age_window, -1) * head(I1_l, -1)) -
      c(1/365 / head(age_window, -1) * head(I1_l, -1), 0) -
      I1_l * gamma -
      I1_l * delta
    
    dR1 <-
      I1_h  * gamma +
      c(0, 1/365 / head(age_window, -1) * head(R1_h, -1)) -
      c(1/365 / head(age_window, -1) * head(R1_h, -1), 0) -
      R1_h * sigma -
      R1_h * delta
    dR1_L <-
      I1_l  * gamma +
      c(0, 1/365 / head(age_window, -1) * head(R1_l, -1)) -
      c(1/365 / head(age_window, -1) * head(R1_l, -1), 0) -
      R1_l * sigma -
      R1_l * delta
    
    #second infection
    dS2 <- 
      R1_h * sigma +
      c(0, 1/365 / head(age_window, -1) * head(S2_h, -1)) -
      c(1/365 / head(age_window, -1) * head(S2_h, -1), 0) -
      S2_h * (3/4 * beta * infected_total_h / population_h) -
      S2_h * delta
    dS2_L <- 
      R1_l * sigma +
      c(0, 1/365 / head(age_window, -1) * head(S2_l, -1)) -
      c(1/365 / head(age_window, -1) * head(S2_l, -1), 0) -
      S2_l * (3/4 * beta_l * infected_total_l / population_l) -
      S2_l * delta

    dI2 <- 
      S2_h * (3/4 * beta * infected_total_h / population_h) +
      c(0, 1/365 / head(age_window, -1) * head(I2_h, -1)) -
      c(1/365 / head(age_window, -1) * head(I2_h, -1), 0) -
      I2_h * gamma -
      I2_h * delta
    dI2_L <- 
      S2_l * (3/4 * beta_l * infected_total_l / population_l) +
      c(0, 1/365 / head(age_window, -1) * head(I2_l, -1)) -
      c(1/365 / head(age_window, -1) * head(I2_l, -1), 0) -
      I2_l * gamma -
      I2_l * delta
    
    dR2 <-  
      I2_h * gamma +  
      c(0, 1/365 / head(age_window, -1) * head(R2_h, -1)) -
      c(1/365 / head(age_window, -1) * head(R2_h, -1), 0) -
      R2_h * sigma -
      R2_h * delta
    dR2_L <-  
      I2_l * gamma +  
      c(0, 1/365 / head(age_window, -1) * head(R2_l, -1)) -
      c(1/365 / head(age_window, -1) * head(R2_l, -1), 0) -
      R2_l * sigma -
      R2_l * delta
    
    #third infection
    dS3 <- 
      R2_h * sigma + 
      c(0, 1/365 / head(age_window, -1) * head(S3_h, -1)) -
      c(1/365 / head(age_window, -1) * head(S3_h, -1), 0) -
      S3_h * (2/4 * beta * infected_total_h / population_h) -
      S3_h * delta
    dS3_L <- 
      R2_l * sigma + 
      c(0, 1/365 / head(age_window, -1) * head(S3_l, -1)) -
      c(1/365 / head(age_window, -1) * head(S3_l, -1), 0) -
      S3_l * (2/4 * beta_l * infected_total_l / population_l) -
      S3_l * delta
    
    dI3 <- 
      S3_h * (2/4 * beta * infected_total_h / population_h) +
      c(0, 1/365 / head(age_window, -1) * head(I3_h, -1)) -
      c(1/365 / head(age_window, -1) * head(I3_h, -1), 0) -
      I3_h * gamma -
      I3_h * delta
    dI3_L <- 
      S3_l * (2/4 * beta_l * infected_total_l / population_l) +
      c(0, 1/365 / head(age_window, -1) * head(I3_l, -1)) -
      c(1/365 / head(age_window, -1) * head(I3_l, -1), 0) -
      I3_l * gamma -
      I3_l * delta
    
    dR3 <- 
      I3_h * gamma +
      c(0, 1/365 / head(age_window, -1) * head(R3_h, -1)) -
      c(1/365 / head(age_window, -1) * head(R3_h, -1), 0) -
      R3_h * sigma -
      R3_h * delta
    dR3_L <- 
      I3_l * gamma +
      c(0, 1/365 / head(age_window, -1) * head(R3_l, -1)) -
      c(1/365 / head(age_window, -1) * head(R3_l, -1), 0) -
      R3_l * sigma -
      R3_l * delta
    
    #fourth infection
    dS4 <- 
      R3_h * sigma +
      c(0, 1/365 / head(age_window, -1) * head(S4_h, -1)) -
      c(1/365 / head(age_window, -1) * head(S4_h, -1), 0) -
      S4_h * (1/4 * beta * infected_total_h / population_h) -
      S4_h * delta
    dS4_L <- 
      R3_l * sigma +
      c(0, 1/365 / head(age_window, -1) * head(S4_l, -1)) -
      c(1/365 / head(age_window, -1) * head(S4_l, -1), 0) -
      S4_l * (1/4 * beta_l * infected_total_l / population_l) -
      S4_l * delta
    
    dI4 <- 
      S4_h * (1/4 * beta * infected_total_h / population_h) +
      c(0, 1/365 / head(age_window, -1) * head(I4_h, -1)) -
      c(1/365 / head(age_window, -1) * head(I4_h, -1), 0) -
      I4_h * gamma -
      I4_h * delta
    dI4_L <- 
      S4_l * (1/4 * beta_l * infected_total_l / population_l) +
      c(0, 1/365 / head(age_window, -1) * head(I4_l, -1)) -
      c(1/365 / head(age_window, -1) * head(I4_l, -1), 0) -
      I4_l * gamma -
      I4_l * delta
    
    dR4 <- 
      I4_h * gamma +
      c(0, 1/365 / head(age_window, -1) * head(R4_h, -1)) -
      c(1/365 / head(age_window, -1) * head(R4_h, -1), 0) -
      R4_h * delta 
    dR4_L <- 
      I4_l * gamma +
      c(0, 1/365 / head(age_window, -1) * head(R4_l, -1)) -
      c(1/365 / head(age_window, -1) * head(R4_l, -1), 0) -
      R4_l * delta
    
  list(c(dS1, dI1, dR1,
         dS2, dI2, dR2,
         dS3, dI3, dR3,
         dS4, dI4, dR4,
         dS1_L, dI1_L, dR1_L,
         dS2_L, dI2_L, dR2_L,
         dS3_L, dI3_L, dR3_L,
         dS4_L, dI4_L, dR4_L))
  
}
```


```{r run model}
y_init <- c(susceptible_h(1), infected_h(1), recovered_h(1),
            susceptible_h(2), infected_h(2), recovered_h(2),
            susceptible_h(3), infected_h(3), recovered_h(3),
            susceptible_h(4), infected_h(4), recovered_h(4),
            susceptible_l(1), infected_l(1), recovered_l(1),
            susceptible_l(2), infected_l(2), recovered_l(2),
            susceptible_l(3), infected_l(3), recovered_l(3),
            susceptible_l(4), infected_l(4), recovered_l(4))

times <- seq(from = 0, to = 365 * 30, by = 0.1)

out <- ode(times = times, y = y_init, func = model, parms = parms)

final <- (dim(out)[1])

```

```{r Plot by class over time}
#Plot susceptibles
susceptible_names <- c("Susceptible 1", "Susceptible 2", "Susceptible 3", "Susceptible 4")
for(i in 0:3){
  x <- 1 + 3 * i
  y <- x + 12
  legend_y <- max(rowSums(out[,(1+(x-1)*28+1):(1+(x)*28)]))
  {plot(out[,1],rowSums(out[,(1+(x-1)*28+1):(1+(x)*28)]),type='l', 
       col = "red", lwd = 2,
       main = susceptible_names[i + 1], ylab = "total")
  lines(out[,1],rowSums(out[,(1+(y-1)*28+1):(1+(y)*28)]),type='l', lwd = 2)
  legend(8000, (2/3) * legend_y, legend=c("Beta = 0.75", "Beta = 1.25"), lwd = c(2,2),
       col=c("red", "black"), cex=0.8)}
  }

#Plot infecteds 
infected_names <- c("Infected 1", "Infected 2", "Infected 3", "Infected 4")
for(i in 0:3){
  x <- 2 + 3 * i
  y <- x + 12
  legend_y <- max(rowSums(out[,(1+(x-1)*28+1):(1+(x)*28)]))
  {plot(out[,1],rowSums(out[,(1+(x-1)*28+1):(1+(x)*28)]),type='l', 
      col = "red", lwd = 2, 
       main = infected_names[i + 1])
  lines(out[,1],rowSums(out[,(1+(y-1)*28+1):(1+(y)*28)]),type='l', lwd = 2)
  legend(8000, (2/3) * legend_y, legend=c("Beta = 0.75", "Beta = 1.25"),
  col=c("red", "black"), lwd = c(2,2), cex=0.8)
}}

#Plot recovered
recovered_names <- c("Recovered 1", "Recovered 2", "Recovered 3", "Recovered 4")
for(i in 0:3){
  x <- 3 + 3 * i
  y <- x + 12
  legend_y <- max(rowSums(out[,(1+(y-1)*28+1):(1+(y)*28)]))
  {plot(out[,1],rowSums(out[,(1+(x-1)*28+1):(1+(x)*28)]), type = 'l', 
      lwd = 2, col = "red",
      main = recovered_names[i + 1], ylim = c(0, max(rowSums(out[,(1+(y-1)*28+1):(1+(y)*28)]))))
  lines(out[,1],rowSums(out[,(1+(y-1)*28+1):(1+(y)*28)]), type = 'l', lwd = 2)
  legend(8000, (2/3) * legend_y, legend=c("Beta = 0.75", "Beta = 1.25"),
  col=c("red", "black"), lwd = c(2,2), cex=0.8)}}
```


```{r beta  1.25}
#Plot susceptibles
{plot(out[,1],rowSums(out[,(1+(13-1)*28+1):(1+(13)*28)]),type='l', main = "Susceptible, Beta = 1.25", ylab = "Total", xlab = "Timestep")
lines(out[,1],rowSums(out[,(1+(16-1)*28+1):(1+(16)*28)]),type='l', col ="red")
lines(out[,1],rowSums(out[,(1+(19-1)*28+1):(1+(19)*28)]),type='l', col ="blue")
lines(out[,1],rowSums(out[,(1+(22-1)*28+1):(1+(22)*28)]),type='l', col ="green")
legend_y <- max(rowSums(out[,(1+(13-1)*28+1):(1+(23)*28)]))
legend(8000, (5/6) * legend_y, legend=c("Susceptible 1", "Susceptible 2", "Susceptible 3", "Susceptible 4"),
       col=c("black","red", "blue","green"), lty=1, cex=0.8)
}


#Plot infected
ylim <- (0.05) * max(rowSums(out[,(1+(14-1)*28+1):(1+(14)*28)])) + (0.95) * max(rowSums(out[,(1+(5-1)*28+1):(1+(5)*28)]))
{plot(out[,1],rowSums(out[,(1+(14-1)*28+1):(1+(14)*28)]),type='l', ylim= c(0,ylim), main = "Infected, Beta = 1.25", ylab = "Total", xlab = "Timestep")
lines(out[,1],rowSums(out[,(1+(17-1)*28+1):(1+(17)*28)]),type='l', col ="red")
lines(out[,1],rowSums(out[,(1+(20-1)*28+1):(1+(20)*28)]),type='l', col ="blue")
lines(out[,1],rowSums(out[,(1+(23-1)*28+1):(1+(23)*28)]),type='l', col ="green")
legend(8000, (5/6) * ylim, legend=c("Infected 1", "Infected 2", "Infected 3", "Infected 4"),
       col=c("black","red", "blue","green"), lty = 1, cex=0.8)
}

#Plot Recovered
{plot(out[,1],rowSums(out[,(1+(15-1)*28+1):(1+(15)*28)]),type='l',  main = "Recovered, Beta = 1.25", ylab = "Total", xlab = "Timestep")
lines(out[,1],rowSums(out[,(1+(18-1)*28+1):(1+(18)*28)]),type='l', col ="red")
lines(out[,1],rowSums(out[,(1+(21-1)*28+1):(1+(21)*28)]),type='l', col ="blue")
lines(out[,1],rowSums(out[,(1+(24-1)*28+1):(1+(24)*28)]),type='l', col ="green")
legend_y <- max(rowSums(out[,(1+(15-1)*28+1):(1+(15)*28)]))
legend(8000, (5/6) * legend_y, legend=c("Recovered 1", "Recovered 2", "Recovered 3", "Recovered 4"),
       col=c("black","red", "blue","green"), lty=1, cex=0.8)
}
```

```{r  beta  0.75}
#Plot susceptibles
{plot(out[,1],rowSums(out[,(1+(1-1)*28+1):(1+(1)*28)]),type='l', main = "Susceptible, Beta = 0.75", ylab = "Total", xlab = "Timestep")
lines(out[,1],rowSums(out[,(1+(4-1)*28+1):(1+(4)*28)]),type='l', col ="red")
lines(out[,1],rowSums(out[,(1+(7-1)*28+1):(1+(7)*28)]),type='l', col ="blue")
lines(out[,1],rowSums(out[,(1+(10-1)*28+1):(1+(10)*28)]),type='l', col ="green")
legend_y <- max(rowSums(out[,(1+(1-1)*28+1):(1+(1)*28)]))
legend(8000, (5/6) * legend_y, legend=c("Susceptible 1", "Susceptible 2", "Susceptible 3", "Susceptible 4"),
       col=c("black","red", "blue","green"), lty=1, cex=0.8)
}


#Plot infected
ylim <- (0.05) * max(rowSums(out[,(1+(2-1)*28+1):(1+(2)*28)])) + (0.95) * max(rowSums(out[,(1+(5-1)*28+1):(1+(5)*28)]))
{plot(out[,1],rowSums(out[,(1+(2-1)*28+1):(1+(2)*28)]),type='l', ylim= c(0,ylim), main = "Infected, Beta = 0.75", ylab = "Total", xlab = "Timestep")
lines(out[,1],rowSums(out[,(1+(5-1)*28+1):(1+(5)*28)]),type='l', col ="red")
lines(out[,1],rowSums(out[,(1+(8-1)*28+1):(1+(8)*28)]),type='l', col ="blue")
lines(out[,1],rowSums(out[,(1+(11-1)*28+1):(1+(11)*28)]),type='l', col ="green")
legend(8000, (5/6) * ylim, legend=c("Infected 1", "Infected 2", "Infected 3", "Infected 4"),
       col=c("black","red", "blue","green"), lty = 1, cex=0.8)
}

#Plot Recovered
{plot(out[,1],rowSums(out[,(1+(3-1)*28+1):(1+(3)*28)]),type='l',  main = "Recovered, Beta = 0.75", ylab = "Total", xlab = "Timestep")
lines(out[,1],rowSums(out[,(1+(6-1)*28+1):(1+(6)*28)]),type='l', col ="red")
lines(out[,1],rowSums(out[,(1+(9-1)*28+1):(1+(9)*28)]),type='l', col ="blue")
lines(out[,1],rowSums(out[,(1+(12-1)*28+1):(1+(12)*28)]),type='l', col ="green")
legend_y <- max(rowSums(out[,(1+(3-1)*28+1):(1+(3)*28)]))
legend(8000, (5/6) * legend_y, legend=c("Recovered 1", "Recovered 2", "Recovered 3", "Recovered 4"),
       col=c("black","red", "blue","green"), lty=1, cex=0.8)
}
``` 

```{r stacked bar charts beta  0.75}
axis_names <- c(seq(0:19), "to 29", "to 39", "to 49", "to 59", "to 69",
            "to 79", "to 89", "to 99")

S1_h_prop <- rep(NA, 28)
for(i in 1:28){
  col <- i + 1
  S1_h_prop[i] <- out[final,col] / sum(out[final,2:85])
}
I1_h_prop <- rep(NA, 28)
for(i in 1:28){
  col <- i + 29 
  I1_h_prop[i] <- out[final,col] / sum(out[final,2:85])
}
R1_h_prop <- rep(NA, 28)
for(i in 1:28){
  col <- i + 29 + 28
  R1_h_prop[i] <- out[final,col] / sum(out[final,2:85])
}
first_h <- matrix(rep(NA, 28 * 3), ncol = 28)
first_h[1,] <- S1_h_prop
first_h[2,] <- I1_h_prop
first_h[3,] <- R1_h_prop

barplot(first_h, main="Proportion of Ages in the First Infection Cycle, Beta = 0.75",
  xlab="Ages", col=c("aliceblue","deeppink3", "darkslategray"),
 	legend = c("Susceptible", "Infected", "Recovered"))

S2_h_prop <- rep(NA, 28)
for(i in 85:112){
  col <- i + 1
  S2_h_prop[i - 84] <- out[final,col] / sum(out[final,86:169])
}
I2_h_prop <- rep(NA, 28)
for(i in 85:112){
  col <- i + 28 + 1
  I2_h_prop[i - 84] <- out[final,col] / sum(out[final,86:169])
}
R2_h_prop <- rep(NA, 28)
for(i in 85:112){
  col <- i + 28 + 28 + 1
  R2_h_prop[i - 84] <- out[final,col] / sum(out[final,86:169])
}
second_h <- matrix(rep(NA, 28 * 3), ncol = 28)
second_h[1,] <- S2_h_prop
second_h[2,] <- I2_h_prop
second_h[3,] <- R2_h_prop


{barplot(second_h,
  xlab="Ages", col=c("aliceblue","deeppink3", "darkslategray"),
 	legend = c("Susceptible", "Infected", "Recovered"), names.arg = axis_names)
  title("Proportion of Ages in the Second Infection Cycle, Beta = 0.75", line = 1)
  box()
  axis(2,at=seq(0,0.07,0.01))}

S3_h_prop <- rep(NA, 28)
for(i in 169:196){
  col <- i + 1
  S3_h_prop[i - 168] <- out[final,col] / sum(out[final,170:253])
}
I3_h_prop <- rep(NA, 28)
for(i in 169:196){
  col <- i + 1 + 28
  I3_h_prop[i - 168] <- out[final,col] / sum(out[final,170:253])
}
R3_h_prop <- rep(NA, 28)
for(i in 169:196){
  col <- i + 1 + 28 + 28
  R3_h_prop[i - 168] <- out[final,col] / sum(out[final,170:253])
}
third_h <- matrix(rep(NA, 28 * 3), ncol = 28)
third_h[1,] <- S3_h_prop
third_h[2,] <- I3_h_prop
third_h[3,] <- R3_h_prop

{barplot(third_h, main="Proportion of Ages in the Third Infection Cycle, Beta = 0.75",
  xlab="Ages", col=c("aliceblue","deeppink3", "darkslategray"),
 	names.arg = axis_names)
  legend(3, 0.09, legend = c("Susceptible", "Infected", "Recovered"), col = c("aliceblue","deeppink3", "darkslategray"), lwd = rep(4, 3))
  box()
  axis(2,seq(0,0.1,0.01))}


S4_h_prop <- rep(NA, 28)
for(i in 253:280){
  col <- i + 1
  S4_h_prop[i - 252] <- out[final,col] / sum(out[final,254:337])
}
I4_h_prop <- rep(NA, 28)
for(i in 253:280){
  col <- i + 1 + 28
  I4_h_prop[i - 252] <- out[final,col] / sum(out[final,254:337])
}
R4_h_prop <- rep(NA, 28)
for(i in 253:280){
  col <- i + 1 + 28 + 28
  R4_h_prop[i - 252] <- out[final,col] / sum(out[final,254:337])
}
fourth_h <- matrix(rep(NA, 28 * 3), ncol = 28)
fourth_h[1,] <- S4_h_prop
fourth_h[2,] <- I4_h_prop
fourth_h[3,] <- R4_h_prop

{barplot(fourth_h, main="Proportion of Ages in the Fourth Infection Cycle, Beta = 0.75", ylim = c(0,0.25),
  xlab="Ages", col=c("aliceblue","deeppink3", "darkslategray"), names.arg = axis_names)
 	legend(3, 0.20, legend = c("Susceptible", "Infected", "Recovered"), lwd = rep(5,3), col = c("aliceblue","deeppink3", "darkslategray"))
  box()}

```

```{r}
{
  #plot 1
  barplot(first_h, main="Proportion of Ages in the First Infection Cycle, Beta = 0.75",
  xlab="Ages", col=c("aliceblue","deeppink3", "darkslategray"),
 	legend = c("Susceptible", "Infected", "Recovered"))
  #plot 2
  {barplot(second_h,
  xlab="Ages", col=c("aliceblue","deeppink3", "darkslategray"),
 	legend = c("Susceptible", "Infected", "Recovered"), names.arg = axis_names)
  title("Proportion of Ages in the Second Infection Cycle, Beta = 0.75", line = 1)
  box()
  axis(2,at=seq(0,0.07,0.01))}
  #plot 3
  {barplot(third_h, main="Proportion of Ages in the Third Infection Cycle, Beta = 0.75",
  xlab="Ages", col=c("aliceblue","deeppink3", "darkslategray"),
 	names.arg = axis_names)
  legend(3, 0.09, legend = c("Susceptible", "Infected", "Recovered"), col = c("aliceblue","deeppink3", "darkslategray"), lwd = rep(4, 3))
  box()
  axis(2,seq(0,0.1,0.01))}
  #plot 4
  {barplot(fourth_h, main="Proportion of Ages in the Fourth Infection Cycle, Beta = 0.75", ylim = c(0,0.25),
  xlab="Ages", col=c("aliceblue","deeppink3", "darkslategray"), names.arg = axis_names)
 	legend(3, 0.20, legend = c("Susceptible", "Infected", "Recovered"), lwd = rep(5,3), col = c("aliceblue","deeppink3", "darkslategray"))
  box()}
}
```



```{r stacked bar plots beta  1.25}
S1_l_prop <- rep(NA, 28)
for(i in 1:28){
  col <- i + 1 + 28 * 12
  S1_l_prop[i] <- out[final,col] / sum(out[final,338:421])
}
I1_l_prop <- rep(NA, 28)
for(i in 1:28){
  col <- i + 1 + 28 * 13 
  I1_l_prop[i] <- out[final,col] / sum(out[final,338:421])
}
R1_l_prop <- rep(NA, 28)
for(i in 1:28){
  col <- i + 1 + 28 * 14
  R1_l_prop[i] <- out[final,col] / sum(out[final,338:421])
}
first_l <- matrix(rep(NA, 28 * 3), ncol = 28)
first_l[1,] <- S1_l_prop
first_l[2,] <- I1_l_prop
first_l[3,] <- R1_l_prop

{barplot(first_l, main="Proportion of Ages in the First Infection Cycle, Beta = 1.25",
  xlab="Ages", col=c("aliceblue","deeppink3", "darkslategray"), names.arg = axis_names,
 	legend = c("Susceptible", "Infected", "Recovered"))
  box()}

S2_l_prop <- rep(NA, 28)
for(i in 85:112){
  col <- i + 1 + 28 * 12
  S2_l_prop[i - 84] <- out[final,col] / sum(out[final,422:505])
}
I2_l_prop <- rep(NA, 28)
for(i in 85:112){
  col <- i + 1 + 28 * 13
  I2_l_prop[i - 84] <- out[final,col] / sum(out[final,422:505])
}
R2_l_prop <- rep(NA, 28)
for(i in 85:112){
  col <- i + 1 + 28 * 14
  R2_l_prop[i - 84] <- out[final,col] / sum(out[final,422:505])
}
second_l <- matrix(rep(NA, 28 * 3), ncol = 28)
second_l[1,] <- S2_l_prop
second_l[2,] <- I2_l_prop
second_l[3,] <- R2_l_prop

{barplot(second_l, main="Proportion of Ages in the Second Infection Cycle, Beta = 1.25",
  xlab="Ages", col=c("aliceblue","deeppink3", "darkslategray"),
 	legend = c("Susceptible", "Infected", "Recovered"), names.arg = axis_names)
  box()}

S3_l_prop <- rep(NA, 28)
for(i in 169:196){
  col <-  i + 1 + 28 * 12
  S3_l_prop[i - 168] <- out[final,col] / sum(out[final,506:589])
}
I3_l_prop <- rep(NA, 28)
for(i in 169:196){
  col <-  i + 1 + 28 * 13
  I3_l_prop[i - 168] <- out[final,col] / sum(out[final,506:589])
}
R3_l_prop <- rep(NA, 28)
for(i in 169:196){
  col <-  i + 1 + 28 * 14
  R3_l_prop[i - 168] <- out[final,col] / sum(out[final,506:589])
}
third_l <- matrix(rep(NA, 28 * 3), ncol = 28)
third_l[1,] <- S3_l_prop
third_l[2,] <- I3_l_prop
third_l[3,] <- R3_l_prop

{barplot(third_h, main="Proportion of Ages in the Third Infection Cycle, Beta = 1.25",
  xlab="Ages", col=c("aliceblue","deeppink3", "darkslategray"),names.arg = axis_names)
 	legend(3,0.08,legend = c("Susceptible", "Infected", "Recovered"), lwd = rep(5,3), col = c("aliceblue","deeppink3", "darkslategray"))
  box()}


S4_l_prop <- rep(NA, 28)
for(i in 253:280){
  col <-i + 1 + 28 * 12
  S4_l_prop[i - 252] <- out[final,col] / sum(out[final,590:673])
}
I4_l_prop <- rep(NA, 28)
for(i in 253:280){
  col <- i + 1 + 28 * 13
  I4_l_prop[i - 252] <- out[final,col] / sum(out[final,590:673])
}
R4_l_prop <- rep(NA, 28)
for(i in 253:280){
  col <- i + 1 + 28 * 14
  R4_l_prop[i - 252] <- out[final,col] / sum(out[final,590:673])
}
fourth_l <- matrix(rep(NA, 28 * 3), ncol = 28)
fourth_l[1,] <- S4_l_prop
fourth_l[2,] <- I4_l_prop
fourth_l[3,] <- R4_l_prop

{barplot(fourth_h, main="Proportion of Ages in the Fourth Infection Cycle, Beta = 1.25", ylim = c(0,0.25),
  xlab="Ages", col=c("aliceblue","deeppink3", "darkslategray"),names.arg = axis_names)
 	legend(3, 0.2,legend = c("Susceptible", "Infected", "Recovered"), lwd = rep(5, 30), col = c("aliceblue","deeppink3", "darkslategray"))
box()}
```

```{r}
{
  #one
  {barplot(first_l, main="Proportion of Ages in the First Infection Cycle, Beta = 1.25",
  xlab="Ages", col=c("aliceblue","deeppink3", "darkslategray"), names.arg = axis_names,
 	legend = c("Susceptible", "Infected", "Recovered"))
  box()}
  #two
  {barplot(second_l, main="Proportion of Ages in the Second Infection Cycle, Beta = 1.25",
  xlab="Ages", col=c("aliceblue","deeppink3", "darkslategray"),
 	legend = c("Susceptible", "Infected", "Recovered"), names.arg = axis_names)
  box()}
  #three
  {barplot(third_h, main="Proportion of Ages in the Third Infection Cycle, Beta = 1.25",
  xlab="Ages", col=c("aliceblue","deeppink3", "darkslategray"),names.arg = axis_names)
 	legend(3,0.08,legend = c("Susceptible", "Infected", "Recovered"), lwd = rep(5,3), col = c("aliceblue","deeppink3", "darkslategray"))
  box()}
  #four
  {barplot(fourth_h, main="Proportion of Ages in the Fourth Infection Cycle, Beta = 1.25", ylim = c(0,0.25),
  xlab="Ages", col=c("aliceblue","deeppink3", "darkslategray"),names.arg = axis_names)
 	legend(3, 0.2,legend = c("Susceptible", "Infected", "Recovered"), lwd = rep(5, 30), col = c("aliceblue","deeppink3", "darkslategray"))
box()}
  
}
```


```{r crude SP9 calc}
nines <- c(1, 29, 57,
           85, 113, 141,
           169, 197, 225, 
           253, 281, 309)
blank <- rep(NA, 12)

for(i in 1:12){
  nine <- nines[i] + 10
  blank[i] <- out[final, nine]
}

SP9 <- 1- (blank[1] / sum(blank))

#do the same for the higher beta
nines_l <- (12 * 28) + c(1, 29, 57,
           85, 113, 141,
           169, 197, 225, 
           253, 281, 309)
blank_l  <- rep(NA, 12)

for(i in 1:12){
  nine_l <- nines[i] + 10
  blank_l[i] <- out[final, nine]
}

SP9_l <- 1- (blank_l[1] / sum(blank_l))

```

